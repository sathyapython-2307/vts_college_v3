{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/course_features.css' %}">
<style>
    .course-details-hero {
        background-color: rgb(171, 255, 233);
        padding: 3rem 0;
    }
    
    .course-title {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 1rem;
        color: #333;
    }
    
    .instructor-info {
        margin-top: 1.5rem;
        display: flex;
        align-items: center;
    }
    
    .instructor-images {
        position: relative;
        width: 90px;
        height: 50px;
    }
    
    
    .instructor-image-wrapper {
        position: absolute;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .instructor-image-wrapper:first-child {
        left: 0;
    }
    
    .instructor-image-wrapper:last-child {
        left: 30px;
        z-index: 2;
    }
    
    .instructor-image-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border: 3px solid white;
        border-radius: 50%;
    }
    
    .instructor-text {
        margin-left: 1rem;
        font-size: 16px;
        line-height: 1;
    }
    
    .instructor-text .text-muted {
        color: #666 !important;
    }
    
    .instructor-names {
        font-weight: 500;
        display: inline;
        margin-left: 4px;
    }
    
    .original-price {
        color: #6c757d;
        font-size: 1.25rem;
        text-decoration-line: line-through;
        margin-right: 0.75rem;

    }
    
    .discounted-price {
        color: #28a745;
        font-size: 1.75rem;
        font-weight: bold;
    }
    
    .course-content-description {
        line-height: 1.8;
    }
    
    .btn-primary {
        background-color: #28a745;
        border-color: #28a745;
        padding: 0.75rem 2rem;
        font-size: 1.125rem;
        border-radius: 0.5rem;
    }
    
    .btn-primary:hover {
        background-color: #218838;
        border-color: #218838;
    }

    
</style>
{% endblock %}

{% block content %}
<!-- Course Details Section -->
<section class="course-details-hero py-5" style="background-color: #87e3d1;" data-course-id="{{ course.id }}">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="course-title" style="text-align: left; color: #24b10b;">{{ course.name }}</h1>
                <p class="course-description" style="font-size: large; font-weight: bolder;">{{ course.description }}</p>
                <div class="instructor-info d-flex align-items-center mt-4">
                    <div class="instructor-images position-relative" style="width: 90px;">
                        {# Prefer manual per-course instructors (local_instructors). Fall back to global CourseInstructor if none. #}
                        {% if local_instructors and local_instructors.exists %}
                            {% for li in local_instructors %}
                                    <div class="instructor-image-wrapper position-absolute" 
                                         style="width: 50px; height: 50px; {% if forloop.first %}left: 0;{% else %}left: 30px;{% endif %} {% if not forloop.first %}z-index: 2;{% endif %}">
                                        <img src="{% if li.image %}{{ li.image.url }}{% else %}{% static 'images/default-profile.png' %}{% endif %}" 
                                             alt="{{ li.name }}"
                                             class="rounded-circle border border-3 border-white"
                                             style="width: 100%; height: 100%; object-fit: cover;">
                                    </div>
                            {% endfor %}
                        {% else %}
                                {% for course_instructor in course_instructors %}
                                    <div class="instructor-image-wrapper position-absolute" 
                                         style="width: 50px; height: 50px; {% if forloop.first %}left: 0;{% else %}left: 30px;{% endif %} {% if not forloop.first %}z-index: 2;{% endif %}">
                                        <img src="{% if course_instructor.instructor.image %}{{ course_instructor.instructor.image.url }}{% else %}{% static 'images/default-profile.png' %}{% endif %}" 
                                             alt="{{ course_instructor.instructor.name }}"
                                             class="rounded-circle border border-3 border-white"
                                             style="width: 100%; height: 100%; object-fit: cover;">
                                    </div>
                                {% endfor %}
                        {% endif %}
                    </div>
                    <div class="instructor-text ms-3 mt-5" style="font-size: 20px;">
                        <span class="text-bold">Instructor: </span>
                        <span class="instructor-names" style="font-weight: 500;">
                            {% if local_instructors and local_instructors.exists %}
                                {% for li in local_instructors %}
                                    {{ li.name }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            {% else %}
                                {% with instructors=course_instructors %}
                                    {% if instructors.count > 0 %}
                                        {{ instructors.0.instructor.name }}{% if instructors.count > 1 %}, {{ instructors.1.instructor.name }}{% endif %}
                                    {% endif %}
                                {% endwith %}
                            {% endif %}
                        </span>
                    </div>
                </div>
                <div class="price-section mt-4" style="position: relative; top: 20px;">
                    <div class="d-flex align-items-center">
                        {% if course.original_price %}
                            <span class="original-price text-decoration-line-through me-3">‚Çπ{{ course.original_price }}</span>
                        {% endif %}
                        {% if course.discounted_price %}
                            <span class="discounted-price fs-3 fw-bold">‚Çπ{{ course.discounted_price }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="action-section mt-4">
                    {% if has_access %}
                        <a href="#schedule-accordion" class="btn btn-success btn-lg start-learning-btn" style="background-color: #1e7e34; border: none;" onclick="document.querySelector('#schedule-accordion').scrollIntoView({ behavior: 'smooth' }); return false;">Start Learning</a>
                    {% else %}
                            {% if request.user.is_authenticated %}
                                <a href="{% url 'course_checkout' course.slug %}" class="btn btn-primary btn-lg" style="background-color: #24b10b; border: none;">Buy Now</a>
                            {% else %}
                                <a href="{% url 'signup' %}?next={% url 'course_detail' slug=course.slug %}" class="btn btn-primary btn-lg" style="background-color: #24b10b; border: none;">Buy Now</a>
                            {% endif %}
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6">
                <!-- column intentionally left blank to preserve layout -->
            </div>
        </div>
    </div>
</section>

<!-- Course Features Section -->
<section class="course-features-section">
    <div class="container">
        <h1>{{ course.name }} Features</h1>
        <div class="features-card">
            <div class="features-grid">
                {% for feature in course_features %}
                <div class="feature-item">
                    <div class="icon-wrapper">
                        <i class="{{ feature.icon }}"></i>
                    </div>
                    <div class="feature-content">
                        <h3>{{ feature.title }}</h3>
                        <p>{{ feature.description }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</section>
<!-- couse overview section -->
<div class="course-overview-section">
<div class="tabs">
        <button class="tab active">Course Overview</button>
        <button class="tab">Reviews</button>
    </div>

    <div class="content-area">
        <div class="skills-section">
            <h2>Skills you'll gain</h2>
            <div class="skill-tags">
                {% for skill in course_skills %}
                    <span class="skill-tag">{{ skill.name }}</span>
                {% endfor %}
            </div>
        </div>

        <div class="tools-section">
            <h2>Tools You Learn</h2>
            <div class="tools-list">
                {% for tool in course_tools %}
                    <div class="tool-item">
                        {% if tool.icon %}
                            <img src="{{ tool.icon.url }}" alt="{{ tool.name }}" class="tool-icon">
                        {% else %}
                            <i class="fas fa-tools tool-icon"></i>
                        {% endif %}
                        <span class="tool-name">{{ tool.name }}</span>
                    </div>
                    {% if not forloop.last %}
                        <span class="separator">,</span>
                    {% else %}
                        <span class="separator">.</span>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        {% for overview in course_overviews %}
        <div class="details-section">
            <h2>{{ overview.title }}</h2>
            <p class="description">
                {{ overview.description }}
            </p>
            {% if overview.image %}
                <img src="{{ overview.image.url }}" alt="{{ overview.title }}" class="overview-image">
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
</div>

    {% if brochure %}
    <div class="download-brochure-section">
        <h2 class="header-title">{{ brochure.title }}</h2>
        <button class="download-btn" onclick="openBrochureModal()">Download Brochure</button>
    </div>

    

    <!-- Brochure Download Modal -->
    <div id="brochureModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Download Course Brochure</h2>
            <form id="brochureForm">
                {% csrf_token %}
                <div class="form-group">
                    <label for="userName">Full Name*</label>
                    <input type="text" id="userName" name="user_name" required>
                </div>
                <div class="form-group">
                    <label for="userEmail">Email Address*</label>
                    <input type="email" id="userEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label for="userPhone">Phone Number*</label>
                    <input type="tel" id="userPhone" name="phone" required>
                </div>
                <button type="submit" class="submit-btn">Download Now</button>
            </form>
        </div>
    </div>

    <style>
    .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 30px;
        border: 1px solid #888;
        width: 90%;
        max-width: 500px;
        border-radius: 8px;
        position: relative;
    }

    .close {
        position: absolute;
        right: 20px;
        top: 15px;
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover {
        color: #000;
    }

    .modal h2 {
        margin-bottom: 20px;
        color: #333;
        font-size: 24px;
        text-align: center;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: 500;
    }

    .form-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
    }

    .submit-btn {
        width: 100%;
        padding: 12px;
        background-color: #52c41a;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .submit-btn:hover {
        background-color: #45a81a;
    }

    @media (max-width: 768px) {
        .modal-content {
            margin: 20% auto;
            padding: 20px;
        }
    }
    </style>

    <script>
    function openBrochureModal() {
        document.getElementById('brochureModal').style.display = 'block';
    }

    document.querySelector('.close').onclick = function() {
        document.getElementById('brochureModal').style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == document.getElementById('brochureModal')) {
            document.getElementById('brochureModal').style.display = 'none';
        }
    }

    // Create notification div if it doesn't exist
    let notificationDiv = document.getElementById('notification');
    if (!notificationDiv) {
        notificationDiv = document.createElement('div');
        notificationDiv.id = 'notification';
        document.body.appendChild(notificationDiv);
    }

    // Add notification styles
    const style = document.createElement('style');
    style.textContent = `
        #notification {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: #52c41a;
            color: white;
            border-radius: 4px;
            font-size: 16px;
            z-index: 10000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    `;
    document.head.appendChild(style);

    document.getElementById('brochureForm').onsubmit = function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch("{% url 'download_brochure' slug=course.slug %}", {
            method: 'POST',
            credentials: 'same-origin',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.blob())
        .then(blob => {
            // Create a URL for the blob
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "{{ course.name }}_brochure.pdf";
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Close modal after successful download
            document.getElementById('brochureModal').style.display = 'none';

            // Show success notification
            notificationDiv.textContent = 'Brochure downloaded successfully!';
            notificationDiv.style.display = 'block';
            
            // Hide notification after 3 seconds
            setTimeout(() => {
                notificationDiv.style.display = 'none';
            }, 3000);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to download brochure. Please try again.');
        });
    };
    </script>
    {% endif %}

<!-- Course Schedule / Curriculum (admin-manageable) -->
{% comment %} Render course schedule days and items. Admins can add CourseScheduleDay and CourseScheduleItem. {% endcomment %}
{% if grouped_schedule_days %}
<div class="course-schedule-wrapper" style="max-width:1200px;margin:24px auto;padding:10px;">
    <div id="schedule-accordion" class="schedule-accordion">
        {% for day in grouped_schedule_days %}
            {% with is_first_day=forloop.first %}
            <div class="schedule-day">
                <button class="schedule-day-toggle" aria-expanded="false">
                    <span class="day-title">{{ day.title }}</span>
                    <span class="day-icon">‚ñæ</span>
                </button>
                <div class="schedule-day-panel">
                    <ul class="schedule-items-list">
                        {% for item in day.items %}
                            <li class="schedule-item video-item" data-video-url="{% if item.video_url %}{{ item.video_url }}{% elif item.video_file %}{{ item.video_file.url }}{% endif %}" data-video-type="{% if item.video_url %}external{% elif item.video_file %}file{% else %}none{% endif %}" data-allowed="{% if is_first_day or has_access %}true{% else %}false{% endif %}" data-item-id="{{ item.id }}" data-course-id="{{ course.id }}">
                                    <div class="thumb-wrapper">
                                        {% if item.thumbnail %}
                                            <img src="{{ item.thumbnail.url }}" alt="{{ item.title }} thumbnail" class="video-thumb" />
                                        {% else %}
                                            <div class="video-thumb placeholder">üìπ</div>
                                        {% endif %}
                                        </div>
                                    <div class="item-content">
                                        <div>
                                            <div class="item-title">{{ item.title }} <span class="video-duration">{% if item.duration %}‚Ä¢ {{ item.duration }}{% endif %}</span></div>
                                            {% if item.description %}
                                                <div class="item-desc">{{ item.description }}</div>
                                            {% endif %}
                                        </div>
                                        {# Render controls depending on day and purchase status #}
                                        {% if is_first_day or has_access %}
                                            {# Show a prominent Play button for allowed users #}
                                            <a href="#" class="play-overlay btn btn-sm btn-success" role="button" aria-label="Play {{ item.title }}">Play</a>
                                        {% else %}
                                            {# Non-paid users see Buy Now overlay. If anonymous, send them to signup first. #}
                                            {% if request.user.is_authenticated %}
                                                <a class="buy-overlay btn btn-sm btn-primary" href="{% url 'course_checkout' course.slug %}">Buy Now</a>
                                            {% else %}
                                                <a class="buy-overlay btn btn-sm btn-primary" href="{% url 'signup' %}?next={% url 'course_detail' slug=course.slug %}">Buy Now</a>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endwith %}
        {% endfor %}
    </div>
</div>
{% endif %}

{% if show_congratulations %}
<script>
document.addEventListener('DOMContentLoaded', function(){
    try {
        if (typeof showCongratulations === 'function') showCongratulations();
    } catch (e) { console.error('Error showing congratulations:', e); }
});
</script>
{% endif %}

{% if grouped_schedule_days %}
<div style="max-width:1200px;margin:0 auto;padding:0 10px;">
    {% include 'exam_prompt.html' %}
</div>
{% endif %}

<style>
/* Schedule accordion styles (responsive) */
.schedule-day { border-radius:8px; margin-bottom:12px; overflow:hidden; border:1px solid rgba(0,0,0,0.08); background:#fff; }
.schedule-day-toggle { width:100%; text-align:left; background:transparent; border:none; padding:14px 18px; display:flex; justify-content:space-between; align-items:center; font-size:18px; cursor:pointer; }
.schedule-day-toggle .day-title { font-weight:600; }
.schedule-day-toggle .day-icon { transition: transform .25s ease; font-size:20px; color:#444; }
.schedule-day-panel { max-height:0; overflow:hidden; transition: max-height .28s ease; background:#fff; border-top:1px solid rgba(0,0,0,0.04); }
.schedule-day-panel.open { max-height:1000px; }
.schedule-items-list { list-style:none; margin:0; padding:10px 18px; }
.schedule-item { display:flex; gap:12px; align-items:center; padding:12px 0; border-bottom:1px solid rgba(0,0,0,0.04); position:relative; }
.schedule-item:last-child { border-bottom:none; }
.thumb-wrapper { position:relative; width:24px; min-width:24px; height:24px; flex-shrink:0; }
.video-thumb { width:24px; height:24px; object-fit:cover; border-radius:4px; }
.video-thumb.placeholder { background:#f5f5f5; display:flex; align-items:center; justify-content:center; font-size:12px; border-radius:4px; }
.item-content { display: flex; flex: 1; justify-content: space-between; align-items: center; }
.schedule-item .play-overlay {
    background: #52c41a;
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    margin-left: 12px;
    white-space: nowrap;
}
.schedule-item .play-overlay:hover { background: #45a81a; }
.item-title { font-weight:600; font-size:16px; }
.item-desc { color:#666; margin-top:4px; font-size:13px; }

/* Buy overlay button shown to non-paid users */
.schedule-item .buy-overlay {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    padding:6px 10px;
    background:#52c41a;
    color:#fff;
    border-radius:6px;
    font-size:13px;
    text-decoration:none;
    display:inline-block;
}

@media (max-width:768px) {
    .schedule-day-toggle { padding:12px 14px; font-size:16px; }
    .schedule-items-list { padding:8px 14px; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function(){
    const toggles = document.querySelectorAll('.schedule-day-toggle');
    toggles.forEach(btn => {
        btn.addEventListener('click', function(){
            const panel = this.nextElementSibling;
            const icon = this.querySelector('.day-icon');
            const isOpen = panel.classList.contains('open');
            if (isOpen) {
                panel.classList.remove('open');
                icon.style.transform = 'rotate(0deg)';
                this.setAttribute('aria-expanded','false');
            } else {
                panel.classList.add('open');
                icon.style.transform = 'rotate(180deg)';
                this.setAttribute('aria-expanded','true');
            }
        });
    });
    // Video modal behavior
    function isYouTubeUrl(url){
        return /youtu(?:\.be|be\.com)\//.test(url);
    }

    function youTubeEmbed(url){
        // extract id
        const m = url.match(/(?:youtu\.be\/|v=)([A-Za-z0-9_-]{6,})/);
        if(m && m[1]) return 'https://www.youtube.com/embed/' + m[1] + '?autoplay=1';
        return url;
    }

    // Create modal container
    const modal = document.createElement('div');
    modal.className = 'video-modal';
    modal.id = 'video-modal';
    modal.innerHTML = `
        <div class="video-backdrop"></div>
        <div class="video-inner">
            <button class="video-close" aria-label="Close">‚úï</button>
            <div class="video-container"></div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.style.display = 'none';

    function openVideo(url, type, itemId, courseId){
        console.log('üé¨ openVideo called:', { url: url?.substring(0, 30), type, itemId, courseId });
        
        const container = modal.querySelector('.video-container');
        container.innerHTML = '';
        if(!url) return;
        
        let videoElement = null;
        
        if(type === 'external' && isYouTubeUrl(url)){
            console.log('‚ñ∂ Playing YouTube video, will mark watched after 3 seconds');
            const iframe = document.createElement('iframe');
            iframe.src = youTubeEmbed(url);
            iframe.width = '100%';
            iframe.height = '100%';
            iframe.setAttribute('allow','autoplay; encrypted-media');
            iframe.setAttribute('frameborder','0');
            container.appendChild(iframe);
            // For YouTube, mark as watched after short delay (user has started watching)
            setTimeout(() => {
                console.log('‚è± 3 seconds passed for YouTube video');
                markVideoWatched(courseId, itemId);
            }, 3000);
        } else if(type === 'file'){
            console.log('‚ñ∂ Playing file video, tracking with ended + 80% watched events');
            const video = document.createElement('video');
            video.controls = true;
            video.autoplay = true;
            video.style.width = '100%';
            video.style.height = '100%';
            video.style.objectFit = 'contain';
            video.style.background = '#000';
            
            // Set video src directly and request metadata preload. Using `video.src`
            // avoids some race conditions with <source> and makes readyState updates
            // more reliable in certain browsers.
            try {
                video.preload = 'metadata';
                video.src = url;
            } catch(e) { console.warn('setting video.src failed', e); }
            // Add fallback text
            video.textContent = 'Your browser does not support the video tag.';
            
            container.appendChild(video);
            videoElement = video;

            // Create a large centered play overlay as a fallback if autoplay is blocked.
            const bigPlay = document.createElement('button');
            bigPlay.className = 'video-big-play';
            bigPlay.type = 'button';
            bigPlay.innerHTML = '\u25B6'; // triangle play icon
            bigPlay.style.position = 'absolute';
            bigPlay.style.left = '50%';
            bigPlay.style.top = '50%';
            bigPlay.style.transform = 'translate(-50%, -50%)';
            bigPlay.style.zIndex = 2100;
            bigPlay.style.border = 'none';
            bigPlay.style.background = 'rgba(0,0,0,0.5)';
            bigPlay.style.color = '#fff';
            bigPlay.style.fontSize = '40px';
            bigPlay.style.width = '84px';
            bigPlay.style.height = '84px';
            bigPlay.style.borderRadius = '50%';
            bigPlay.style.display = 'none';
            bigPlay.style.cursor = 'pointer';
            bigPlay.setAttribute('aria-label', 'Play video');
            container.appendChild(bigPlay);

            // Helper to show the big play overlay
            function showBigPlay() { bigPlay.style.display = 'block'; }
            function hideBigPlay() { bigPlay.style.display = 'none'; }

            // Click on big play should attempt to play again
            bigPlay.addEventListener('click', function(){
                hideBigPlay();
                try {
                    video.play().catch(err => {
                        console.warn('play() after bigPlay click rejected:', err);
                        // try muted autoplay fallback
                        try {
                            video.muted = true;
                            video.play().then(() => {
                                console.log('muted play() succeeded after user tap');
                                showUnmute();
                            }).catch(err2 => {
                                console.warn('muted play() also rejected:', err2);
                                showBigPlay();
                            });
                        } catch(e2) { console.warn('muted play() error:', e2); showBigPlay(); }
                    });
                } catch(e){ console.warn('play() error after bigPlay click:', e); }
            });

            // Unmute control shown when muted autoplay fallback used
            const unmuteBtn = document.createElement('button');
            unmuteBtn.className = 'video-unmute-btn';
            unmuteBtn.type = 'button';
            unmuteBtn.textContent = '\uD83D\uDD0A'; // speaker icon
            unmuteBtn.style.position = 'absolute';
            unmuteBtn.style.right = '12px';
            unmuteBtn.style.bottom = '12px';
            unmuteBtn.style.zIndex = 2200;
            unmuteBtn.style.border = 'none';
            unmuteBtn.style.background = 'rgba(0,0,0,0.5)';
            unmuteBtn.style.color = '#fff';
            unmuteBtn.style.fontSize = '18px';
            unmuteBtn.style.width = '44px';
            unmuteBtn.style.height = '44px';
            unmuteBtn.style.borderRadius = '6px';
            unmuteBtn.style.display = 'none';
            unmuteBtn.style.cursor = 'pointer';
            unmuteBtn.setAttribute('aria-label', 'Unmute video');
            container.appendChild(unmuteBtn);

            function showUnmute() { unmuteBtn.style.display = 'block'; }
            function hideUnmute() { unmuteBtn.style.display = 'none'; }
            unmuteBtn.addEventListener('click', function(){
                try { video.muted = false; hideUnmute(); } catch(e){ console.warn('unmute error', e); }
            });

            // Improve playback behavior: allow inline playback on mobile and
            // explicitly call play() after the user click. Many browsers block
            // autoplay with audio even when `autoplay` is set; calling play()
            // after the user's click and handling rejections gives better UX.
            try {
                video.playsInline = true;
                video.setAttribute('playsinline', '');
            } catch (e) { /* ignore */ }

            try {
                const playResult = video.play();
                if (playResult && typeof playResult.then === 'function') {
                    playResult.then(() => {
                        console.log('video.play() succeeded');
                        hideBigPlay();
                        // if previously muted fallback was used, show unmute control
                        if (video.muted) showUnmute();
                    }).catch(err => {
                        console.warn('video.play() rejected (autoplay may be blocked):', err);
                        // show the large play button so user can explicitly start playback
                        showBigPlay();
                        // also show a small transient hint
                        const hint = document.createElement('div');
                        hint.className = 'video-play-hint';
                        hint.textContent = 'Tap the play button to start playback';
                        hint.style.position = 'absolute';
                        hint.style.left = '50%';
                        hint.style.bottom = '48px';
                        hint.style.transform = 'translateX(-50%)';
                        hint.style.background = 'rgba(0,0,0,0.6)';
                        hint.style.color = '#fff';
                        hint.style.padding = '6px 10px';
                        hint.style.borderRadius = '6px';
                        hint.style.zIndex = 2100;
                        container.appendChild(hint);
                        setTimeout(() => { try { container.removeChild(hint); } catch(e){} }, 5000);
                    });
                }

            // Add verbose event logging to help diagnose playback issues
            ['loadedmetadata','canplay','canplaythrough','play','playing','pause','waiting','stalled','suspend','error','progress','timeupdate'].forEach(evt => {
                video.addEventListener(evt, function(e){
                    console.log('video event ->', evt, { currentTime: video.currentTime, duration: video.duration, paused: video.paused, muted: video.muted });
                });
            });
            } catch (e) { console.warn('video.play() error:', e); }

            // Error handling if the video fails to load
            video.addEventListener('error', function(e){
                console.error('Video playback error for', url, e);
                container.innerHTML = '<div style="color:white;padding:20px;text-align:center;">Failed to load video. File may be missing or inaccessible.</div>';
            });
            
            // If metadata isn't ready and play() rejected, retry after metadata loads
            video.addEventListener('loadedmetadata', function(){
                console.log('video event -> loadedmetadata', { duration: video.duration });
            });

            // Track when video ends
            video.addEventListener('ended', function() {
                console.log('‚úì Video ended event fired');
                if (!video.dataset.watchTracked) {
                    video.dataset.watchTracked = 'true';
                    markVideoWatched(courseId, itemId);
                }
            });

            // Also track 80% watched
            video.addEventListener('timeupdate', function() {
                if (video.duration && video.currentTime / video.duration > 0.8) {
                    if (!video.dataset.watchTracked) {
                        console.log('‚úì Video 80% watched event fired');
                        video.dataset.watchTracked = 'true';
                        markVideoWatched(courseId, itemId);
                    }
                }
            });

            // No explicit video.load() here ‚Äî calling play() will start loading.
        } else {
            // fallback: open url in new tab
            console.log('‚Üó Opening URL in new tab (no video player)');
            window.open(url, '_blank');
            return;
        }
        modal.classList.add('open');
    }
    
    // markVideoWatched -> call server API to record watch and get updated progress
    function markVideoWatched(courseId, itemId) {
        console.log('Calling markVideoWatched API:', { courseId, itemId });
        const apiUrl = `/course/${courseId}/video/${itemId}/mark-watched/`;
        return fetch(apiUrl, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({})
        })
        .then(resp => resp.json())
        .then(data => {
            console.log('markVideoWatched response:', data);
            if (data && data.success) {
                // keep the latest completion payload globally available for the congrats UI
                window.lastCompletionData = data;
                updateProgressUI(data);
                if (data.ready_for_exam === true || data.all_watched === true) {
                    console.log('üéâ Backend indicates course fully watched ‚Äî showing congratulations');
                    showCongratulations();
                }
            }
            return data;
        }).catch(err => {
            console.error('Error calling markVideoWatched:', err);
            return { success: false, error: err };
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function updateProgressUI(data) {
        // Update any progress elements on the page
        const progressBar = document.querySelector('.course-progress-bar');
        const progressText = document.querySelector('.course-progress-text');
        
        if (progressBar) {
            progressBar.style.width = data.progress_percentage + '%';
        }
        if (progressText) {
            progressText.textContent = Math.round(data.progress_percentage) + '%';
        }

        // Update exam stats if available
        if (data.total_questions) {
            const questionsEl = document.getElementById('stat-total-questions');
            if (questionsEl) {
                questionsEl.textContent = data.total_questions;
            }
        }

        if (data.exam_duration_minutes) {
            const durationEl = document.getElementById('stat-exam-duration');
            if (durationEl) {
                const hours = Math.floor(data.exam_duration_minutes / 60);
                const mins = data.exam_duration_minutes % 60;
                const durationText = hours > 0 
                    ? (mins > 0 ? `${hours}h ${mins}m` : `${hours}h`)
                    : `${mins}m`;
                durationEl.textContent = durationText;
            }
        }
    }
    
    function showExamPrompt() {
        // Legacy helper kept for compatibility; now simply shows the congratulations container.
        showCongratulations();
    }
    
    function dismissCongrats() {
        const container = document.getElementById('congratulations-container');
        if (container) {
            container.style.display = 'none';
        }
    }
    
    function startExamFlow() {
        // Get course ID from the hero section or video items
        const courseId = document.querySelector('.course-details-hero')?.getAttribute('data-course-id') 
                      || document.querySelector('[data-course-id]')?.getAttribute('data-course-id');
        
        console.log('Starting exam flow with courseId:', courseId);
        
        if (!courseId) {
            console.error('Course ID not found in page');
            alert('Error: Course ID not found. Please refresh the page and try again.');
            return;
        }
        
        // Redirect to exam start
        const examUrl = `/course/${courseId}/exam/start/`;
        console.log('Redirecting to:', examUrl);
        window.location.href = examUrl;
    }

    // Expose important functions to global scope so inline onclick handlers can call them
    window.startExamFlow = startExamFlow;
    window.dismissCongrats = dismissCongrats;
    // `restoreCongrats` may be defined in another template; expose safely to avoid ReferenceError
    window.restoreCongrats = (typeof restoreCongrats === 'function') ? restoreCongrats : function(){ console.warn('restoreCongrats not defined'); };
    window.showExamPrompt = showExamPrompt;
    window.showCongratulations = showCongratulations;
    window.markVideoWatched = markVideoWatched;
    window.openVideo = openVideo;

    modal.addEventListener('click', function(e){
        if(e.target.classList.contains('video-backdrop') || e.target.classList.contains('video-close')){
            modal.classList.remove('open');
            const container = modal.querySelector('.video-container');
            container.innerHTML = '';
        }
    });

    // Initialize page - check if all videos completed
    console.log('Page initialized');
    const congrats = document.getElementById('congratulations-container');
    if (congrats) {
        console.log('Congratulations container found, current display:', window.getComputedStyle(congrats).display);
    } else {
        console.error('Congratulations container NOT FOUND on page!');
    }
    
    // Check server-side completion status on page load and show congrats if ready
    function checkCompletionOnPageLoad() {
        const courseId = document.querySelector('.course-details-hero')?.getAttribute('data-course-id') 
                      || document.querySelector('[data-course-id]')?.getAttribute('data-course-id');
        if (!courseId) return;
        const url = `/course/${courseId}/check-completion/`;
        console.log('Calling checkCompletionOnPageLoad:', url);
        fetch(url, { method: 'GET', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' } })
            .then(resp => resp.json())
            .then(data => {
                console.log('checkCompletionOnPageLoad response:', data);
                if (data && data.success) {
                    // cache for congrats UI
                    window.lastCompletionData = data;
                    updateProgressUI(data);
                    if (data.ready_for_exam === true || data.all_watched === true) {
                        showCongratulations();
                    }
                }
            }).catch(err => { console.error('checkCompletionOnPageLoad error', err); });
    }
    
    // Run completion check when page loads
    checkCompletionOnPageLoad();
    
    // No session-based clearing. Visibility is DB-driven and persistent across logins.
    const videoItems = document.querySelectorAll('.video-item');
    console.log('Found', videoItems.length, 'video items');
    
    videoItems.forEach((li, idx) => {
        const btn = li.querySelector('.play-overlay');
        const buyLink = li.querySelector('.buy-overlay');
        const videoUrl = li.getAttribute('data-video-url');
        const videoType = li.getAttribute('data-video-type');
        const itemId = parseInt(li.getAttribute('data-item-id'), 10);
        const courseId = parseInt(li.getAttribute('data-course-id'), 10);
        const allowed = li.getAttribute('data-allowed') === 'true';
        
        console.log(`[VIDEO-ITEM-${idx}] itemId=${itemId}, courseId=${courseId}, allowed=${allowed}, has-btn=${!!btn}, videoUrl="${videoUrl?.substring(0,50)}", type=${videoType}`);

        if (btn) {
            btn.addEventListener('click', function(e){
                console.log(`[PLAY-CLICK-${idx}] Event fired for itemId=${itemId}`);
                e.preventDefault();
                e.stopPropagation();
                if(!allowed) {
                    console.log(`[PLAY-CLICK-${idx}] User not allowed, redirecting to checkout`);
                    if (buyLink) window.location.href = buyLink.href;
                    return;
                }
                if(!videoUrl){
                    console.log(`[PLAY-CLICK-${idx}] No video URL!`);
                    alert('No video available');
                    return;
                }
                console.log(`[PLAY-CLICK-${idx}] Opening video: ${videoUrl.substring(0,50)}`);
                openVideo(videoUrl, videoType, itemId, courseId);
            });
        }

        // also open when clicking the whole list item, but only if allowed
        li.addEventListener('click', function(e){
            // if click originated on a buy button or play button, let those handlers run
            if (e.target.closest('.buy-overlay') || e.target.closest('.play-overlay')) return;
            if(!allowed) {
                // non-paid users clicking the item should be sent to checkout
                if (buyLink) window.location.href = buyLink.href;
                return;
            }
            if(!videoUrl) return;
            openVideo(videoUrl, videoType, itemId, courseId);
        });
    });

});
</script>

<style>
/* Video modal styles */
.video-modal { position:fixed; inset:0; z-index:2000; background:rgba(0,0,0,0.8); }
.video-modal { display:none; }
.video-modal.open { display:flex !important; align-items:center; justify-content:center; }
.video-backdrop { position:absolute; inset:0; background:rgba(0,0,0,0.6); }
.video-inner { position:relative; width:90%; max-width:900px; aspect-ratio:16/9; background:#000; border-radius:8px; overflow:hidden; z-index:2001; }
.video-close { position:absolute; right:8px; top:8px; z-index:2002; background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.3); color:#fff; font-size:20px; padding:6px 10px; cursor:pointer; border-radius:4px; }
.video-close:hover { background:rgba(255,255,255,0.3); }
.video-container { width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#000; }
.thumb-wrapper { position:relative; width:24px; min-width:24px; height:24px; flex-shrink:0; }
.video-thumb { width:24px; height:24px; object-fit:cover; border-radius:4px; }
.video-thumb.placeholder { background:#eee; display:flex; align-items:center; justify-content:center; font-size:12px; border-radius:4px; }
.video-duration { color:#777; font-weight:400; font-size:13px; margin-left:8px; }

/* Congratulations Container Styles */
.congratulations-container {
    max-width: 1200px;
    margin: 40px auto;
    padding: 0 10px;
    text-align: center;
}

.congrats-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 16px;
    padding: 60px 40px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    animation: celebrateIn 0.6s ease-out;
}

@keyframes celebrateIn {
    from {
        opacity: 0;
        transform: scale(0.95) translateY(20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.congrats-icon {
    font-size: 64px;
    margin-bottom: 16px;
    display: inline-block;
    animation: bounce 0.6s ease-out;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.congrats-content h2 {
    font-size: 36px;
    margin: 16px 0;
    font-weight: bold;
}

.congrats-content p {
    font-size: 16px;
    margin-bottom: 32px;
    line-height: 1.6;
    opacity: 0.95;
}

.congrats-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 32px;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}

.congrats-stats .stat {
    background: rgba(255, 255, 255, 0.2);
    padding: 16px;
    border-radius: 12px;
    backdrop-filter: blur(10px);
}

.stat-value {
    font-size: 28px;
    font-weight: bold;
    margin-bottom: 4px;
}

.stat-label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    opacity: 0.9;
}

.congrats-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
}

.btn-start-exam, .btn-remind-later {
    padding: 12px 28px;
    border: none;
    border-radius: 6px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-start-exam {
    background: white;
    color: #667eea;
}

.btn-start-exam:hover {
    background: #f0f0f0;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.btn-remind-later {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    backdrop-filter: blur(10px);
}

.btn-remind-later:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

@media (max-width: 600px) {
    .congrats-content {
        padding: 40px 20px;
    }
    
    .congrats-content h2 {
        font-size: 28px;
    }
    
    .congrats-content p {
        font-size: 14px;
    }
    
    .congrats-stats {
        grid-template-columns: 1fr;
    }
    
    .congrats-buttons {
        flex-direction: column;
    }
    
    .btn-start-exam, .btn-remind-later {
        width: 100%;
    }
}

@media (max-width: 600px) {
    .video-max-mobile { max-width: 320px !important; }
}
</style>

</script>

<style>
    .course-features-section {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 40px 20px;
    background-color: white;
}

.course-features-section .container {
    max-width: 1200px;
    margin: 0 auto;
}

.course-features-section h1 {
    text-align: center;
    font-size: 2.5rem;
    color: #1a1a1a;
    margin-bottom: 50px;
    font-weight: 600;
}

.features-card {
    background: white;
    border-radius: 20px;
    padding: 50px 40px;
    
}

.features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 40px;
}

.feature-item {
    display: flex;
    align-items: flex-start;
    gap: 20px;
}

.icon-wrapper {
    flex-shrink: 0;
    width: 60px;
    height: 60px;
    border: 2px solid #7ed957;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(126, 217, 87, 0.1);
}

.icon-wrapper i {
    font-size: 24px;
    color: #7ed957;
}

.feature-content h3 {
    font-size: 1.5rem;
    color: #1a1a1a;
    margin-bottom: 8px;
    font-weight: 600;
}

.feature-content p {
    font-size: 1rem;
    color: #666;
    line-height: 1.5;
}

@media (max-width: 768px) {
    .course-features-section h1 {
        font-size: 2rem;
        margin-bottom: 30px;
    }

    .features-card {
        padding: 30px 20px;
    }

    .features-grid {
        grid-template-columns: 1fr;
        gap: 30px;
    }

    .feature-item {
        gap: 15px;
    }

    .icon-wrapper {
        width: 50px;
        height: 50px;
    }

    .icon-wrapper i {
        font-size: 20px;
    }

    .feature-content h3 {
        font-size: 1.25rem;
    }

    .feature-content p {
        font-size: 0.95rem;
    }
}

@media (max-width: 480px) {
    .course-features-section {
        padding: 20px 10px;
    }

    .course-features-section h1 {
        font-size: 1.5rem;
    }
}

/* course over view section */
     .course-overview-section {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #e8f5e9;
            border-radius: 10px;
            padding: 0;
            margin-top: 25px;
        }

        .course-overview-section .tabs {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background-color: #d4edda;
            border-radius: 10px 10px 0 0;
        }

        .course-overview-section .tab {
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: white;
            color: #333;
        }

        .course-overview-section .tab.active {
            background-color: #4caf50;
            color: white;
        }

        .course-overview-section .content-area {
            padding: 30px;
            background-color: white;
        }

        .course-overview-section h2 {
            font-size: 22px;
            margin-bottom: 20px;
            color: #1a1a1a;
            font-weight: 700;
        }

        .course-overview-section .skills-section {
            margin-bottom: 35px;
        }

        .course-overview-section .skill-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .course-overview-section .skill-tag {
            background-color: #d1ebe5;
            padding: 8px 16px;
            border-radius: 5px;
            font-size: 13px;
            font-weight: 600;
            color: #1a1a1a;
            border: 1px solid #b8dbd3;
        }

        .course-overview-section .tools-section {
            margin-bottom: 35px;
        }

        .course-overview-section .tools-list {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            line-height: 1.8;
        }

        .course-overview-section .tool-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .course-overview-section .tool-icon {
            width: 20px;
            height: 20px;
            object-fit: contain;
            vertical-align: middle;
        }
        
        .course-overview-section .tool-icon.fas {
            font-size: 20px;
            color: #4caf50;
        }

        .course-overview-section .tool-name {
            color: #1a1a1a;
            font-weight: 400;
        }

        .course-overview-section .separator {
            color: #333;
            margin: 0 2px;
        }

        .course-overview-section .details-section {
            margin-bottom: 30px;
        }

        .course-overview-section .details-section:last-child {
            margin-bottom: 0;
        }

        .course-overview-section .description {
            font-size: 15px;
            line-height: 1.7;
            color: #1a1a1a;
            text-align: left;
        }

        @media (max-width: 768px) {
            .course-overview-section .tabs {
                padding: 12px 15px;
            }

            .course-overview-section .content-area {
                padding: 20px;
            }

            .course-overview-section .tab {
                padding: 8px 20px;
                font-size: 15px;
            }

            .course-overview-section h2 {
                font-size: 20px;
            }

            .course-overview-section .tools-list {
                font-size: 15px;
            }

            .course-overview-section .description {
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .course-overview-section .tabs {
                flex-direction: column;
                gap: 8px;
            }

            .course-overview-section .tab {
                width: 100%;
                text-align: center;
            }

            .course-overview-section .content-area {
                padding: 15px;
            }

            .course-overview-section h2 {
                font-size: 18px;
            }

            .course-overview-section .skill-tag {
                font-size: 12px;
                padding: 7px 14px;
            }

            .course-overview-section .tool-icon {
                width: 18px;
                height: 18px;
            }

            .course-overview-section .tools-list {
                font-size: 14px;
            }
        }

        /* download brochure section */
 .download-brochure-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: white;
            padding: 20px 40px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
            gap: 15px;
            width: 65%;
            margin: auto;
            margin-bottom: 25px;
        }

        .download-brochure-section .header-title {
            font-size: 28px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0;
        }

        .download-brochure-section .download-btn {
            background-color: #52c41a;
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            white-space: nowrap;
            text-decoration: none;
        }

        .download-brochure-section .download-btn:hover {
            background-color: #45a81a;
            transform: translateY(-1px);
        }

        .download-brochure-section .download-btn:active {
            transform: translateY(0);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .download-brochure-section {
                padding: 15px 25px;
            }

            .download-brochure-section .header-title {
                font-size: 24px;
            }

            .download-brochure-section .download-btn {
                padding: 10px 24px;
                font-size: 15px;
            }
        }

        @media (max-width: 480px) {
            .download-brochure-section {
                padding: 15px 20px;
                justify-content: center;
                text-align: center;
            }

            .download-brochure-section .header-title {
                font-size: 22px;
                width: 100%;
            }

            .download-brochure-section .download-btn {
                width: 100%;
                padding: 12px 20px;
            }
        }
 
</style>
{% endblock %}